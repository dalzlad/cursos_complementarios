<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üß© M√ìDULO 6 ‚Äî Consultas avanzadas, agregaciones y pipeline</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-1: #0ea5a4; 
      --brand-2: #0369a1; 
      --muted: #374151;
      --bg-warm: #f5f9fb;
      --code-bg: #0b1220;
    }
    html { font-size: 18px; }
    body{
      background: linear-gradient(135deg, #f0f6fb 0%, #eef7ff 100%);
      color: #0f172a;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.6;
    }
    .card { background: white; border-radius:14px; box-shadow: 0 10px 30px rgba(2,6,23,0.06); }
    pre.code {
      background: var(--code-bg);
      color: #e6f3f1;
      padding: 1rem;
      border-radius: 10px;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      font-size: 1rem;
      line-height:1.6;
    }
    code.inline { background: rgba(3,105,161,0.06); padding: 0.12rem 0.45rem; border-radius:6px; font-family: ui-monospace, monospace; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .9rem; border-radius:10px; font-weight:600; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(90deg,var(--brand-1),var(--brand-2)); color:white; box-shadow:0 8px 20px rgba(3,105,161,0.12); }
    .btn-ghost{ background:white; border:1px solid rgba(3,105,161,0.08); color:var(--brand-2); }

    details summary { list-style: none; cursor: pointer; padding: .75rem 1rem; border-radius: 10px; background: linear-gradient(180deg, rgba(6,95,70,0.04), transparent); font-weight:600; }
    details[open] summary{ background: linear-gradient(180deg, rgba(3,105,161,0.06), transparent); }
    details > .content { padding: 0.75rem 1rem 1rem 1rem; }

    .small { font-size: .95rem; color:var(--muted); }
    .kbd { background:#111827;color:white;padding:2px 8px;border-radius:6px;font-family:ui-monospace,monospace;font-size:.9rem }

    @media (max-width:768px){
      html { font-size:17px; }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-gray-100">
    <nav class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="../index.html" class="flex items-center gap-2">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background:linear-gradient(180deg,var(--brand-1),var(--brand-2));">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 2C12 2 7 6 7 11C7 15 11 20 12 22C13 20 17 15 17 11C17 6 12 2 12 2Z" fill="white"/></svg>
          </div>
          <span class="font-semibold text-lg text-slate-800">Curso MongoDB</span>
        </a>
      </div>

      <div class="flex items-center gap-3 text-sm font-medium">
        <a href="../modulos/modulo1.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 1</a>
        <a href="../modulos/modulo2.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 2</a>
        <a href="../modulos/modulo3.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 3</a>
        <a href="../modulos/modulo4.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 4</a>
        <a href="../modulos/modulo5.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 5</a>
        <a href="#" class="px-3 py-2 rounded bg-slate-100 text-slate-900 font-semibold">M√≥dulo 6</a>
        <a href="../modulos/modulo7.html" class="px-3 py-2 rounded hover:bg-slate-50">M√≥dulo 7</a>
      </div>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-10">

    <!-- Header / Hero -->
    <section class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900">üß© M√ìDULO 6 ‚Äî Consultas avanzadas, agregaciones y pipeline</h1>
      <p class="text-lg text-gray-600 mt-2">Duraci√≥n: <strong>3 horas</strong> ‚Ä¢ Nivel: <strong>B√°sico</strong></p>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button id="openIndex" class="btn btn-ghost" onclick="location.href='../index.html'">Volver al √≠ndice</button>
      </div>
    </section>

    <!-- Objectives -->
    <section class="card p-6 mb-6">
      <h3 class="text-2xl font-semibold text-slate-900 mb-3">üéØ Objetivos del m√≥dulo</h3>
      <ul class="list-disc pl-6 space-y-2 text-lg text-gray-700">
        <li>Construir consultas complejas y transformaciones de datos.</li>
        <li>Aprender a usar agregaciones con pipelines.</li>
        <li>Aplicar operadores avanzados para an√°lisis estad√≠stico y agrupaciones.</li>
        <li>Dominar etapas: $match, $group, $project, $sort, $lookup, $unwind, $bucket.</li>
        <li>Crear pipelines que integren m√∫ltiples etapas para an√°lisis de datos real.</li>
      </ul>
    </section>

    <!-- 1. Qu√© es agregaci√≥n -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">1Ô∏è‚É£ ¬øQu√© es una agregaci√≥n?</h4>
      <p class="small mb-2">Las agregaciones permiten procesar documentos y devolver resultados computados, similares a GROUP BY, SUM(), AVG(), COUNT() en SQL.</p>
      <p class="small mb-2">Mientras las consultas <code class="inline">find()</code> devuelven documentos filtrados, las agregaciones transforman, agrupan y combinan datos.</p>
      <pre class="code">db.coleccion.aggregate(pipeline)  // pipeline: arreglo de etapas</pre>
    </section>

    <!-- 2. Estructura del Pipeline -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">2Ô∏è‚É£ Estructura del Pipeline</h4>
      <pre class="code">db.pedidos.aggregate([
  { $match: { estado: "entregado" } },
  { $group: { _id: "$cliente", totalCompras: { $sum: "$valor" } } },
  { $sort: { totalCompras: -1 } }
])</pre>
      <ul class="list-disc pl-6 text-gray-700 mt-2">
        <li><strong>$match:</strong> Filtra documentos (similar a WHERE)</li>
        <li><strong>$group:</strong> Agrupa y aplica funciones de agregaci√≥n</li>
        <li><strong>$sort:</strong> Ordena resultados</li>
        <li><strong>$project:</strong> Selecciona o transforma campos</li>
        <li><strong>$limit:</strong> Limita resultados</li>
        <li><strong>$skip:</strong> Omite documentos</li>
        <li><strong>$lookup:</strong> Une colecciones</li>
        <li><strong>$unwind:</strong> Descompone arreglos</li>
        <li><strong>$count:</strong> Cuenta documentos</li>
        <li><strong>$addFields:</strong> Agrega campos calculados</li>
      </ul>
    </section>

    <!-- 3. Operadores comunes -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">3Ô∏è‚É£ Operadores de agregaci√≥n comunes</h4>
      <pre class="code">{
  $sum: "$monto",
  $avg: "$precio",
  $max: "$edad",
  $min: "$edad",
  $count: "total",
  $push: "$nombre"
}</pre>
    </section>

    <!-- 4. Ejemplo pr√°ctico 1 -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">4Ô∏è‚É£ Total de ventas por cliente</h4>
      <pre class="code">db.ventas.insertMany([
  { cliente: "Ana", valor: 120, ciudad: "Bogot√°" },
  { cliente: "Ana", valor: 80, ciudad: "Bogot√°" },
  { cliente: "Luis", valor: 200, ciudad: "Medell√≠n" },
  { cliente: "Sof√≠a", valor: 150, ciudad: "Cali" }
])</pre>
      <pre class="code">db.ventas.aggregate([
  { $group: { _id: "$cliente", totalVentas: { $sum: "$valor" } } },
  { $sort: { totalVentas: -1 } }
])</pre>
    </section>

    <!-- 5. Ejemplo pr√°ctico 2 -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">5Ô∏è‚É£ Promedio de ventas por ciudad</h4>
      <pre class="code">db.ventas.aggregate([
  { $group: { _id: "$ciudad", promedioVentas: { $avg: "$valor" } } }
])</pre>
    </section>

    <!-- 6. $lookup -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">6Ô∏è‚É£ Uso de $lookup (equivalente a JOIN)</h4>
      <pre class="code">db.clientes.aggregate([
  {
    $lookup: {
      from: "pedidos",
      localField: "_id",
      foreignField: "cliente_id",
      as: "pedidos"
    }
  }
])</pre>
    </section>

    <!-- 7. $unwind -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">7Ô∏è‚É£ $unwind ‚Äî Descomponer arreglos</h4>
      <pre class="code">db.clientes.aggregate([
  { $unwind: "$pedidos" },
  { $project: { nombre: 1, "pedidos.producto": 1 } }
])</pre>
    </section>

    <!-- 8. Combinaci√≥n de etapas -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">8Ô∏è‚É£ Combinaci√≥n de etapas</h4>
      <pre class="code">db.ventas.aggregate([
  { $match: { ciudad: "Bogot√°" } },
  { $group: { _id: "$cliente", total: { $sum: "$valor" } } },
  { $sort: { total: -1 } },
  { $limit: 5 }
])</pre>
    </section>

    <!-- 9. $project y expresiones -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">9Ô∏è‚É£ $project ‚Äî Seleccionar y transformar campos</h4>
      <pre class="code">db.ventas.aggregate([
  { $project: { _id:0, cliente:1, ciudad:1, totalConIVA: { $multiply: ["$valor",1.19] } } }
])</pre>
    </section>

    <!-- 10. Expresiones avanzadas -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">üîü Expresiones avanzadas</h4>
      <pre class="code">{
  $cond, $ifNull, $concat, $substr, $toUpper
}</pre>
      <pre class="code">db.usuarios.aggregate([
  {
    $project: {
      nombreCompleto: { $concat: [ "$nombre", " ", "$apellido" ] },
      tipo: { $cond: { if: { $gte: ["$edad",18] }, then: "Adulto", else: "Menor" } }
    }
  }
])</pre>
    </section>

    <!-- 11. $bucket -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">11Ô∏è‚É£ $bucket y $bucketAuto ‚Äî Agrupar por rangos</h4>
      <pre class="code">db.productos.aggregate([
  {
    $bucket: {
      groupBy: "$precio",
      boundaries: [0,100,500,1000],
      default: "Otros",
      output: { cantidad: { $sum:1 } }
    }
  }
])</pre>
    </section>

    <!-- 12. $count, $limit y $skip -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">12Ô∏è‚É£ $count, $limit y $skip</h4>
      <pre class="code">db.usuarios.aggregate([
  { $match: { ciudad: "Bogot√°" } },
  { $count: "usuariosBogota" }
])</pre>
    </section>

    <!-- 13. Ejercicio integrador -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">13Ô∏è‚É£ Ejercicio integrador: an√°lisis de ventas</h4>
      <pre class="code">db.ventas.aggregate([
  // Total de ventas por cliente
])
db.ventas.aggregate([
  // Promedio por ciudad
])
db.ventas.aggregate([
  // 2 clientes con mayor total
])</pre>
    </section>

    <!-- 14. Resumen -->
    <section class="card p-6 mb-6">
      <h4 class="text-xl font-semibold mb-3">14Ô∏è‚É£ Resumen del m√≥dulo</h4>
      <pre class="code">Concepto             Descripci√≥n
$aggregate()          Ejecuta un pipeline de etapas
$match                Filtra documentos
$group                Agrupa
$lookup               Une colecciones
$unwind               Descompone arreglos
$project              Selecciona o crea nuevos campos
$bucket               Agrupa por rangos
$count, $limit, $skip Control de resultados
</pre>
</section>

<!-- 15. Actividad pr√°ctica final -->
<section class="card p-6 mb-6">
  <h4 class="text-xl font-semibold mb-3">15Ô∏è‚É£ Actividad pr√°ctica final</h4>
  <p class="text-gray-700 mb-3">Crea un pipeline que:</p>
  <ul class="list-disc pl-6 space-y-2 text-gray-700">
    <li>Filtre las ventas con <code class="inline">valor > 100</code>.</li>
    <li>Agrupe por ciudad y sume los valores.</li>
    <li>Agregue un campo <code class="inline">impuesto = valorTotal √ó 0.19</code>.</li>
    <li>Ordene de mayor a menor seg√∫n el valor total.</li>
  </ul>
  <p class="small mt-2">üí° Guarda tu pipeline y pru√©balo en MongoDB Atlas usando el <strong>Aggregation Pipeline Builder</strong>.</p>
</section>

<!-- Footer / Navegaci√≥n -->
<div class="flex flex-col md:flex-row items-center justify-between gap-4 mt-6">
  <div class="flex gap-3">
    <a href="../index.html" class="btn btn-ghost">Volver al √≠ndice</a>
  </div>
</div>

<footer class="mt-10 text-center text-sm text-gray-500">
  <p>üìò Gu√≠a de apoyo educativo ‚Äî Versi√≥n 2025
    Desarrollada por Diego L√≥pez con apoyo de Inteligencia Artificial para fines formativos.</p>
</footer>


<script>
  // Marcar m√≥dulo como completado
  const markBtn = document.getElementById('markDoneTop');
  markBtn.addEventListener('click', () => {
    const pressed = markBtn.getAttribute('aria-pressed') === 'true';
    markBtn.setAttribute('aria-pressed', (!pressed).toString());
    markBtn.textContent = !pressed ? 'Completado ‚úÖ' : 'Marcar completado ‚úÖ';
    markBtn.classList.toggle('btn-primary');
  });
</script>

</body>
</html>
